<!-- $Id: example.html,v 1.4 2006/03/27 02:44:36 pat Exp $ -->
<!DOCTYPE HTML>
<html>
<head> 
    <!--<meta http-equiv="Content-Type" content="text/html; charset=gb2312">-->
    <title>疯狂骑士团宝石拼图工具1.0</title>
    <!--<link type="text/css" href="style.css" rel="stylesheet" />-->
    <script type="text/javascript" src="js/mathpc.js"></script>
    <script type="text/javascript" src="js/define.js"></script>
    <script type="text/javascript" src="js/draw.js"></script>
    <script type="text/javascript" src="js/solution.js"></script>
<script>
    var blockCollect = BlockCollect()
    var canvasBlocks = null
    var ctxBlocks = null
    var boardSolution = new Array()
    var select_result = 0
    var canvasSolution = null
    var ctxSolution = null
    document.onreadystatechange = function () {
        if (document.readyState === "interactive") {
            window.localStorage.setItem('status','0')
            canvasBlocks = document.getElementById('canvasBlocks');
            ctxBlocks = canvasBlocks.getContext('2d');
            canvasSolution = document.getElementById('canvasSolution');
            ctxSolution = canvasSolution.getContext('2d');
            document.getElementById('btn_delete').disabled = true;
            canvasBlocks.addEventListener('click', function(e) {
                // var x = event.pageX - canvasBlocks.getBoundingClientRect().left
                // var y = event.pageY - canvasBlocks.getBoundingClientRect().top
                var x = event.offsetX
                var y = event.offsetY
                if(x < 10 || y < 10){
                    return
                }
                let m = Math.trunc((x - 10)/(gridLen*4))
                let n = Math.trunc((y - 10)/(gridLen*4+20))
                let index = n*10+m
                blockCollect.setSelect(index)
                document.getElementById('label_delete').innerText = blockCollect.getSelectCode()
                clearCanvas(canvasBlocks,ctxBlocks)
                drawBlockCollect(blockCollect,ctxBlocks,10,10,canvasBlocks)
                if(blockCollect.select == -1){
                    document.getElementById('btn_delete').disabled = true;
                }else{
                    document.getElementById('btn_delete').disabled = false;
                }
            }, false)
        }
    }

    function btnadd()
    {
        let text = document.getElementById('input_add').value;
        if(!blockCollect.add(text)){
            alert('错误的输入')
            return;
        }
        clearCanvas(canvasBlocks,ctxBlocks)
        drawBlockCollect(blockCollect,ctxBlocks,10,10,canvasBlocks)
    }
    function btndelete()
    {
        blockCollect.del()
        document.getElementById('label_delete').innerText = blockCollect.getSelectCode()
        clearCanvas(canvasBlocks,ctxBlocks)
        drawBlockCollect(blockCollect,ctxBlocks,10,10,canvasBlocks)
    }
    function btnsave()
    {
        if(!blockCollect.saveStorge('blockCollect')){
            alert('无法访问本地缓存')
            return
        }
        alert('保存宝石列表成功')
    }
    function btnload()
    {
        if(!blockCollect.loadStorge('blockCollect')){
            alert('无法访问本地缓存')
            return
        }
        document.getElementById('btn_delete').disabled = true;
        document.getElementById('label_delete').innerText = blockCollect.getSelectCode()
        clearCanvas(canvasBlocks,ctxBlocks)
        drawBlockCollect(blockCollect,ctxBlocks,10,10,canvasBlocks)
        alert('载入宝石列表成功')
    }
    var timer = null
    function loopTimer() {
        timerFlag = true
        timer = setTimeout(loopTimer, 300);
    }
    function btncalc()
    {
        document.all.label_progress.innerText = ''
        document.all.label_count.innerText = '';
        document.all.label_select.innerText = '';
        clearCanvas(canvasSolution,ctxSolution)
        document.getElementById("btn_add").setAttribute("disabled", true);
        timer = setTimeout(loopTimer, 300);
        return
        solutionAsync(blockCollect, (progressInfo) =>{
            document.all.label_progress.innerText = progressInfo
        }).then( bs =>{
            boardSolution = bs
            document.all.label_count.innerText = boardSolution.length.toString()
            select_result = 0
            document.all.label_select.innerText = select_result.toString()
            clearCanvas(canvasSolution,ctxSolution)
            if(boardSolution.length > 0){
                drawBoard(boardSolution[select_result],ctxSolution,10,10)
            }
            document.all.label_progress.innerText = '完成了100%'
            document.getElementById("btn_add").removeAttribute ("disabled")
            clearTimeout(timer)
            timer = null
        })
    }
    var timer2 = null
    function loopTimer2() {
        document.all.label_progress.innerText = window.localStorage.getItem('progressInfo');
        document.all.label_count.innerText = window.localStorage.getItem('label_count');
        let over = window.localStorage.getItem('over')
        if(over == 1){
            select_result = 0
            clearCanvas(canvasSolution,ctxSolution)
            boardSolution.length = 0
            let s = window.localStorage.getItem('boardSolution')
            if(s.length > 0){
                let ss = s.split('$')
                for(let i=0;i<ss.length;i++){
                    let board = new Board().init().deserialize(ss[i])
                    boardSolution.push(board)
                }
            }
            if(boardSolution.length > 0){
                drawBoard(boardSolution[select_result],ctxSolution,10,10)
            }
            document.all.label_progress.innerText = '完成了100%'
            document.getElementById("btn_add").removeAttribute ("disabled")
            clearTimeout(timer)
            timer = null
        }else{
            timer2 = setTimeout(loopTimer2, 500);
        }
    }
    function btncalc2()
    {
        //status: 0 未运行 1 启动运行 2 运行中
        let status = window.localStorage.getItem('status');
        if(status != '0'){
            alert('正在计算中')
            return
        }
        document.all.label_progress.innerText = ''
        document.all.label_count.innerText = ''
        document.all.label_select.innerText = ''
        clearCanvas(canvasSolution,ctxSolution)
        document.getElementById("btn_add").setAttribute("disabled", true)
        blockCollect.saveStorge('calcBlocks')
        // let url = "calc.html"
        // let windowFeatures = "location=no,width=320,height=200,left=0,top=0"
        // window.open(url, 'calc', windowFeatures)
        window.localStorage.setItem('status','1');
        timer2 = setTimeout(loopTimer2, 500);

    }
    function btnleft()
    {
        if(boardSolution == null){
            return
        }
        if(select_result> 0){
            select_result --
            document.all.label_select.innerText = select_result.toString();
            clearCanvas(canvasSolution,ctxSolution)
            drawBoard(boardSolution[select_result],ctxSolution,10,10)
        }
    }
    function btnright()
    {
        if(boardSolution == null){
            return
        }
        if(select_result < boardSolution.length - 1){
            select_result ++
            document.all.label_select.innerText = select_result.toString();
            clearCanvas(canvasSolution,ctxSolution)
            drawBoard(boardSolution[select_result],ctxSolution,10,10)
        }
    }
    function btntest()
    {
        mathpc.generateCombinations(5, 3, (combination) => {
          console.log(`Combination: [${combination}]`);
        });
        mathpc.generatePermutations(5, (permutation) => {
            console.log(`Permutation: [${permutation}]`);
        });    

         // let board = Board()
        // board.init()
        // console.info(board.dump())
        // let block = Block()
        // block.init('131')
        // board.place(block,2,2)
        // console.info(board.dump())
        // let state = board.getGroupState()
        // let keys = Object.keys(state)
        // let debug = 1
        // mathpc.C(10,4,function(buffer){
        //     console.info(buffer)
        // })
        //const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
        // mathpc.CAsync(4, 2, function(buffer){
        //     console.info(buffer)
        // })
        // mathpc.P(5,2,function(buffer){
        //     console.info(buffer)
        // })
        // blockCollect._traverse(25,function(buffer){
        //    console.info(buffer)
        // })
    }
    function btntest2()
    {
        mathpc.PAll2(4,function(buffer){
            console.info(buffer)
        })
    }
</script>
</head>
<body>
    <h1>
        疯狂骑士团宝石拼图工具1.0:</h1>
    <div class="demo">
        <div id="tabs">
            <div id="tabs-1">
                <table border="1" align="left">
                    <tr>
                        <td>
                            <div style="text-align: left">
                                <button id="btn_add" onclick=btnadd() >添加宝石代码</button> 
                                <input id="input_add" type="text" size="20" value='' /><br />
                                <button id="btn_delete" onclick=btndelete()>删除宝石代码</button>
                                <label id="label_delete" name="label_delete"></label><br/>
                                <button id="btn_save" onclick=btnsave()>保存宝石列表</button>
                                <button id="btn_load" onclick=btnload()>载入宝石列表</button><br />
                                <canvas id="canvasBlocks" width="500" height="400" style="border:1px solid #000000;">您的浏览器不支持 HTML5 canvas 标签。</canvas><br/><br/>
                            </div>
                        </td>
                    </tr>
                </table>
                <table border="1" align="left;float:right">
                    <tr>
                        <td>
                            <div style="text-align: left">
                                <button id="btn_calc" onclick=btncalc2()>开始计算</button><br/>
                                <iframe id="calc" title="计算" width="200" height="50" src="calc.html"> </iframe>
                                <label id="label_progress" name="label_progress"></label><br/>
                                一共找到 <label id="label_count" name="label_count"></label> 个结果<br/>
                                <button id="btn_left" onclick=btnleft()><</button>
                                <label id="label_select" name="label_select"></label>
                                <button id="btn_right" onclick=btnright()>></button><br/>
                                <canvas id="canvasSolution" width="500" height="400" style="border:1px solid #000000;">
                                您的浏览器不支持 HTML5 canvas 标签。
                                </canvas>

                            </div>
                            <button id="btn_test" onclick=btntest()>测试</button>
                            <button id="btn_test2" onclick=btntest2()>测试2</button><br/>

                        </td>
                    </tr>
                </table>
                  </div>
            </div>
            <!-- End tabs-1 -->
        </div>
        <!-- End tabs -->
</body>
</html>
